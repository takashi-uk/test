name: Multi DB Copy

on:
  workflow_dispatch:
    inputs:
      source_key:
        description: 'Source DB key (例: DatabaseA)'
        required: true
      target_key:
        description: 'Target DB key (例: DatabaseAcopy)'
        required: true

jobs:
  copy-db:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install jq and PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y jq postgresql-client

      - name: Set DB Info from dbs.json
        id: setdbinfo
        run: |
          SOURCE_KEY="${{ github.event.inputs.source_key }}"
          TARGET_KEY="${{ github.event.inputs.target_key }}"
          DB_JSON=$(cat .github/config/dbs.json)

          # Source DB info
          SOURCE_INFO=$(echo "$DB_JSON" | jq -r ".[] | select(.key==\"$SOURCE_KEY\")")
          echo "SOURCE_RESOURCE_GROUP=$(echo $SOURCE_INFO | jq -r .resource_group)" >> $GITHUB_ENV
          echo "SOURCE_SERVER_NAME=$(echo $SOURCE_INFO | jq -r .server_name)" >> $GITHUB_ENV
          echo "SOURCE_HOST=$(echo $SOURCE_INFO | jq -r .host)" >> $GITHUB_ENV
          echo "SOURCE_USER=$(echo $SOURCE_INFO | jq -r .user)" >> $GITHUB_ENV
          echo "SOURCE_DB_NAME=$(echo $SOURCE_INFO | jq -r .db_name)" >> $GITHUB_ENV
          echo "SOURCE_PASSWORD_SECRET=$(echo $SOURCE_INFO | jq -r .password_secret)" >> $GITHUB_ENV

          # Target DB info
          TARGET_INFO=$(echo "$DB_JSON" | jq -r ".[] | select(.key==\"$TARGET_KEY\")")
          echo "TARGET_RESOURCE_GROUP=$(echo $TARGET_INFO | jq -r .resource_group)" >> $GITHUB_ENV
          echo "TARGET_SERVER_NAME=$(echo $TARGET_INFO | jq -r .server_name)" >> $GITHUB_ENV
          echo "TARGET_HOST=$(echo $TARGET_INFO | jq -r .host)" >> $GITHUB_ENV
          echo "TARGET_USER=$(echo $TARGET_INFO | jq -r .user)" >> $GITHUB_ENV
          echo "TARGET_DB_NAME=$(echo $TARGET_INFO | jq -r .db_name)" >> $GITHUB_ENV
          echo "TARGET_PASSWORD_SECRET=$(echo $TARGET_INFO | jq -r .password_secret)" >> $GITHUB_ENV

      - name: Azure login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Install Azure CLI
        run: curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash

      - name: Export Source DB Password
        run: |
          echo "PGPASSWORD=${{ secrets[env.SOURCE_PASSWORD_SECRET] }}" >> $GITHUB_ENV

      - name: Export Target DB Password
        run: |
          echo "PGPASSWORD_TARGET=${{ secrets[env.TARGET_PASSWORD_SECRET] }}" >> $GITHUB_ENV

      - name: Delete and Recreate Target DB
        run: |
          az postgres flexible-server db delete \
            --resource-group "$TARGET_RESOURCE_GROUP" \
            --server-name "$TARGET_SERVER_NAME" \
            --database-name "$TARGET_DB_NAME" \
            --yes
          az postgres flexible-server db create \
            --resource-group "$TARGET_RESOURCE_GROUP" \
            --server-name "$TARGET_SERVER_NAME" \
            --database-name "$TARGET_DB_NAME"

      - name: Dump Source DB
        env:
          PGPASSWORD: ${{ secrets.SVR14_PASSWORD_SECRET }}
        run: |
          pg_dump --host="$SOURCE_HOST" --username="$SOURCE_USER" --dbname="$SOURCE_DB_NAME" --no-owner --no-privileges > dump.sql

      - name: Restore Target DB
        env:
          PGPASSWORD: ${{ secrets.SVR14COPY_PASSWORD_SECRET }}
        run: |
          pg_restore --host="$TARGET_HOST" --username="$TARGET_USER" --dbname="$TARGET_DB_NAME" --no-owner --no-privileges < dump.sql
